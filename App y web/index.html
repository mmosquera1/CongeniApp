<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale-1.0" />
    <title>CongeniApp - Prototipo</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK (usa type="module" para imports) -->
    <script type="module">
      // --- IMPORTAR SDKs DE FIREBASE ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        setDoc,
        doc,
        getDoc,
        setLogLevel,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      // ¡NUEVO! Importar Firebase Storage
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

      // --- 1. CONFIGURACIÓN DE FIREBASE ---
      // ¡IMPORTANTE! Ve a tu consola de Firebase, crea un proyecto web
      // y pega tu propio objeto de configuración aquí.
      const firebaseConfig = {
        apiKey: "AIzaSyBpDX4QYfSjyTkjUfcWk0hcFIfM8N0AXA8",
        authDomain: "congeniapp.firebaseapp.com",
        projectId: "congeniapp",
        storageBucket: "congeniapp.firebasestorage.app",
        messagingSenderId: "222469089145",
        appId: "1:222469089145:web:b5a2c5cfbc69091647b1a8",
        measurementId: "G-B45X92VBQK",
      };

      // Variables globales de la app
      let app, db, auth, storage; // ¡NUEVO! storage
      let userId = null;
      let currentUserProfile = null; // ¡NUEVO! Para guardar info del usuario (ej. nroVivienda)

      // Usamos el __app_id global si está disponible (para el entorno de Canvas)
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-congeniapp-id";

      // --- 2. INICIALIZAR APP ---
      try {
        const config =
          typeof __firebase_config !== "undefined"
            ? JSON.parse(__firebase_config)
            : firebaseConfig;
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        storage = getStorage(app); // ¡NUEVO! Inicializar Storage
        setLogLevel("Debug"); // Muestra logs detallados de Firestore en la consola
        console.log(
          "Firebase (Auth, Firestore, Storage) inicializado correctamente."
        );
      } catch (e) {
        console.error("Error inicializando Firebase:", e);
        document.body.innerHTML =
          "<h1>Error al conectar con Firebase. Revisa tu configuración en el código.</h1>";
      }

      // --- 3. REFERENCIAS A ELEMENTOS DEL DOM ---
      // (Las asignaremos cuando el DOM esté cargado)
      let authContainer,
        appContainer,
        loadingSpinner,
        loginForm,
        registerForm,
        postForm;
      let userInfo,
        logoutButton,
        postsFeed,
        authTabs,
        loginTab,
        registerTab,
        loginContent,
        registerContent;
      let postSubmitButton; // Para deshabilitar mientras se suben fotos

      // --- 4. LÓGICA DE AUTENTICACIÓN ---

      // Esta función se ejecuta cuando el DOM está listo
      document.addEventListener("DOMContentLoaded", () => {
        // ... Asignar elementos del DOM (igual que antes)
        authContainer = document.getElementById("auth-container");
        appContainer = document.getElementById("app-container");
        loadingSpinner = document.getElementById("loading-spinner");
        loginForm = document.getElementById("login-form");
        registerForm = document.getElementById("register-form");
        postForm = document.getElementById("post-form");
        userInfo = document.getElementById("user-info");
        logoutButton = document.getElementById("logout-button");
        postsFeed = document.getElementById("posts-feed");
        authTabs = document.querySelectorAll('[role="tab"]');
        loginTab = document.getElementById("login-tab");
        registerTab = document.getElementById("register-tab");
        loginContent = document.getElementById("login-content");
        registerContent = document.getElementById("register-content");
        postSubmitButton = document.getElementById("post-submit-button");

        // --- MANEJADOR DE PESTAÑAS (Tabs) ---
        authTabs.forEach((tab) => {
          tab.addEventListener("click", (e) => {
            // ... (sin cambios)
            e.preventDefault();

            // Quitar 'active' de todas
            authTabs.forEach((t) =>
              t.classList.remove("border-blue-500", "text-blue-600")
            );
            authTabs.forEach((t) =>
              t.classList.add(
                "border-transparent",
                "text-gray-500",
                "hover:text-gray-700",
                "hover:border-gray-300"
              )
            );

            // Poner 'active' en la clickeada
            tab.classList.remove(
              "border-transparent",
              "text-gray-500",
              "hover:text-gray-700",
              "hover:border-gray-300"
            );
            tab.classList.add("border-blue-500", "text-blue-600");

            if (tab.id === "login-tab") {
              loginContent.classList.remove("hidden");
              registerContent.classList.add("hidden");
            } else {
              loginContent.classList.add("hidden");
              registerContent.classList.remove("hidden");
            }
          });
        });

        // --- OBSERVADOR DE ESTADO DE AUTH ---
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            // Usuario está logueado
            console.log("Usuario logueado:", user.uid);
            userId = user.uid;

            // ¡NUEVO! Cargar el perfil del usuario de Firestore
            await loadUserProfile(user.uid);

            // Mostrar app, ocultar auth y spinner
            appContainer.classList.remove("hidden");
            authContainer.classList.add("hidden");
            loadingSpinner.classList.add("hidden");

            // Empezar a escuchar las publicaciones
            await setupPostsListener();
          } else {
            // Usuario no está logueado
            console.log("Usuario no logueado.");
            currentUserProfile = null; // Limpiar perfil
            userId = crypto.randomUUID();

            // Mostrar auth, ocultar app y spinner
            appContainer.classList.add("hidden");
            authContainer.classList.remove("hidden");
            loadingSpinner.classList.add("hidden");
          }
        });

        // --- INICIO DE SESIÓN CON TOKEN (Canvas) ---
        // ... (sin cambios)
        (async () => {
          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          ) {
            try {
              console.log("Intentando signInWithCustomToken...");
              await signInWithCustomToken(auth, __initial_auth_token);
              console.log("signInWithCustomToken exitoso.");
            } catch (error) {
              console.error("Error en signInWithCustomToken:", error);
              // Si falla el token, intentar anónimo
              await signInAnonymously(auth);
            }
          } else if (auth.currentUser === null) {
            // Si no hay token y no hay usuario, iniciar como anónimo (o manejar login normal)
            // Para esta app, dejaremos que onAuthStateChanged maneje mostrar el login
            console.log("No hay token inicial. Esperando login manual.");
          }
        })();

        // --- EVENT LISTENERS DE FORMULARIOS ---

        // Login
        // ... (sin cambios)
        loginForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = loginForm.email.value;
          const password = loginForm.password.value;
          try {
            await signInWithEmailAndPassword(auth, email, password);
            console.log("Login exitoso");
            showAppMessage("Inicio de sesión exitoso.", "success");
          } catch (error) {
            console.error("Error de login:", error.message);
            showAppMessage(`Error: ${error.message}`, "error");
          }
        });

        // Registro
        // ... (sin cambios)
        registerForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = registerForm.email.value;
          const password = registerForm.password.value;
          const nombre = registerForm.nombre.value;
          const direccion = registerForm.direccion.value;
          const nroVivienda = registerForm.nroVivienda.value;

          // Validación simple
          if (!nombre || !direccion || !nroVivienda) {
            showAppMessage(
              "Por favor completa todos los campos de registro.",
              "error"
            );
            return;
          }

          try {
            // 1. Crear el usuario en Firebase Auth
            const userCredential = await createUserWithEmailAndPassword(
              auth,
              email,
              password
            );
            const user = userCredential.user;
            console.log("Usuario creado en Auth:", user.uid);

            // 2. Crear el documento del usuario en Firestore
            const userDocRef = doc(
              db,
              `artifacts/${appId}/public/data/users`,
              user.uid
            );

            await setDoc(userDocRef, {
              nombreCompleto: nombre,
              email: email,
              direccion: direccion,
              nroVivienda: nroVivienda,
              esValidado: false, // Aún no validado (geo o manual)
              reputacionPromedio: 5, // Reputación inicial
              createdAt: new Date(),
            });

            console.log("Documento de usuario creado en Firestore.");
            showAppMessage(
              "¡Registro exitoso! Ya puedes iniciar sesión.",
              "success"
            );
            // Cambiar a la pestaña de login
            loginTab.click();
            loginForm.email.value = email;
          } catch (error) {
            console.error("Error de registro:", error.message);
            showAppMessage(`Error de registro: ${error.message}`, "error");
          }
        });

        // Logout
        // ... (sin cambios)
        logoutButton.addEventListener("click", async () => {
          try {
            await signOut(auth);
            console.log("Logout exitoso.");
            postsFeed.innerHTML = ""; // Limpiar el feed al salir
          } catch (error) {
            console.error("Error de logout:", error.message);
          }
        });

        // ¡NUEVO! Lógica de Nuevo Post (con subida de fotos)
        postForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!auth.currentUser || !currentUserProfile) {
            showAppMessage(
              "Debes estar logueado y tu perfil debe estar cargado para publicar.",
              "error"
            );
            return;
          }

          // Deshabilitar botón
          postSubmitButton.disabled = true;
          postSubmitButton.textContent = "Publicando... (esto puede tardar)";
          postSubmitButton.classList.add("opacity-50", "cursor-not-allowed");

          const titulo = postForm.titulo.value;
          const contenido = postForm.contenido.value;
          const tipo = postForm.tipo.value;
          const calificacion = parseInt(postForm.calificacion.value, 10);

          const files = [
            postForm.foto1.files[0],
            postForm.foto2.files[0],
            postForm.foto3.files[0],
          ].filter((file) => file); // Filtrar los que no están definidos

          if (!titulo || !contenido) {
            showAppMessage(
              "El título y el contenido no pueden estar vacíos.",
              "error"
            );
            postSubmitButton.disabled = false;
            postSubmitButton.textContent = "Publicar";
            postSubmitButton.classList.remove(
              "opacity-50",
              "cursor-not-allowed"
            );
            return;
          }

          try {
            // 1. Subir todas las imágenes y obtener URLs
            const uploadPromises = files.map(uploadFile);
            const downloadURLs = await Promise.all(uploadPromises);

            // 2. Usamos la colección pública para que todos vean los posts
            const postsCollection = collection(
              db,
              `artifacts/${appId}/public/data/posts`
            );

            // 3. Agregar el documento a Firestore
            await addDoc(postsCollection, {
              authorId: auth.currentUser.uid,
              authorNroVivienda: currentUserProfile.nroVivienda, // ¡CAMBIO!
              titulo: titulo,
              contenido: contenido,
              tipo: tipo,
              calificacionPost: calificacion,
              imageUrls: downloadURLs, // ¡NUEVO!
              createdAt: new Date(),
            });

            console.log("Post agregado!");
            postForm.reset(); // Limpiar el formulario
            showAppMessage("Publicación creada con éxito.", "success");
          } catch (error) {
            console.error("Error al agregar post:", error);
            showAppMessage("Error al crear la publicación.", "error");
          } finally {
            // Volver a habilitar el botón
            postSubmitButton.disabled = false;
            postSubmitButton.textContent = "Publicar";
            postSubmitButton.classList.remove(
              "opacity-50",
              "cursor-not-allowed"
            );
          }
        });
      });

      // ¡NUEVO! Función para cargar el perfil del usuario
      async function loadUserProfile(uid) {
        try {
          const userDocRef = doc(
            db,
            `artifacts/${appId}/public/data/users`,
            uid
          );
          const docSnap = await getDoc(userDocRef);

          if (docSnap.exists()) {
            currentUserProfile = docSnap.data();
            console.log("Perfil de usuario cargado:", currentUserProfile);
            // ¡CAMBIO! Mostrar nombre completo
            userInfo.textContent = `Hola, ${
              currentUserProfile.nombreCompleto || "Usuario"
            } (Unidad: ${currentUserProfile.nroVivienda})`;
          } else {
            console.warn("No se encontró el documento del perfil de usuario.");
            userInfo.textContent = `Hola, ${auth.currentUser.email} (Perfil no encontrado)`;
          }
        } catch (error) {
          console.error("Error al cargar perfil de usuario:", error);
          userInfo.textContent = `Hola, ${auth.currentUser.email} (Error de perfil)`;
        }
      }

      // ¡NUEVO! Función para subir un archivo a Storage
      async function uploadFile(file) {
        if (!file) return null; // Si no hay archivo, devuelve null

        // Crear una referencia única
        const filePath = `artifacts/${appId}/public/posts/${
          auth.currentUser.uid
        }/${Date.now()}-${file.name}`;
        const storageRef = ref(storage, filePath);

        try {
          console.log(`Subiendo ${file.name}...`);
          await uploadBytes(storageRef, file);
          const downloadURL = await getDownloadURL(storageRef);
          console.log(`Archivo subido, URL: ${downloadURL}`);
          return downloadURL;
        } catch (error) {
          console.error("Error al subir archivo:", error);
          showAppMessage(`Error al subir ${file.name}`, "error");
          return null;
        }
      }

      // --- 5. LÓGICA DE FIRESTORE (POSTS) ---

      let unsubscribePosts = null;
      // ... (sin cambios en setupPostsListener)
      async function setupPostsListener() {
        if (unsubscribePosts) {
          console.log("Deteniendo listener de posts anterior.");
          unsubscribePosts(); // Detener el listener anterior si existe
        }

        if (!auth.currentUser) {
          console.log(
            "No hay usuario, no se puede iniciar el listener de posts."
          );
          return;
        }

        console.log("Iniciando listener de posts...");
        // Usamos la colección pública
        const postsCollection = collection(
          db,
          `artifacts/${appId}/public/data/posts`
        );

        // onSnapshot escucha cambios en tiempo real
        unsubscribePosts = onSnapshot(
          postsCollection,
          (querySnapshot) => {
            console.log(
              "Datos de posts recibidos:",
              querySnapshot.docs.length,
              "documentos"
            );
            postsFeed.innerHTML = ""; // Limpiar feed

            if (querySnapshot.empty) {
              postsFeed.innerHTML =
                '<p class="text-gray-500 text-center">No hay publicaciones todavía. ¡Sé el primero!</p>';
              return;
            }

            // Ordenar por fecha en el cliente (para evitar crear índices)
            const docs = querySnapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            docs.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

            docs.forEach((docData) => {
              renderPost(docData);
            });
          },
          (error) => {
            console.error("Error en el listener de posts:", error);
            showAppMessage("Error al cargar las publicaciones.", "error");
          }
        );
      }

      // --- 6. FUNCIONES DE RENDERIZADO ---

      // ¡ACTUALIZADO! renderPost para mostrar Nro. Vivienda e Imágenes
      function renderPost(doc) {
        const post = doc; // doc ya es el objeto de datos
        const postDate = post.createdAt
          ? post.createdAt.toDate().toLocaleString("es-ES")
          : "Fecha desconocida";

        // Colores según el tipo de post
        const typeColors = {
          ruido: "bg-red-100 border-red-300",
          vecino_bueno: "bg-green-100 border-green-300",
          vecino_malo: "bg-yellow-100 border-yellow-300",
          prestaciones: "bg-blue-100 border-blue-300",
          espacio_verde: "bg-teal-100 border-teal-300",
        };

        // ¡NUEVO! Generar HTML para las imágenes
        let imagesHTML = "";
        if (post.imageUrls && post.imageUrls.length > 0) {
          imagesHTML = '<div class="mt-4 grid grid-cols-3 gap-2">';
          post.imageUrls.forEach((url) => {
            if (url) {
              // Asegurarse de que la URL no es null
              imagesHTML += `
                            <a href="${url}" target="_blank" rel="noopener noreferrer">
                                <img src="${url}" alt="Foto del post" class="w-full h-24 object-cover rounded-md shadow-sm hover:opacity-80 transition-opacity">
                            </a>
                        `;
            }
          });
          imagesHTML += "</div>";
        }

        const postElement = document.createElement("div");
        postElement.className = `bg-white p-4 rounded-lg shadow-md border-l-4 ${
          typeColors[post.tipo] || "bg-gray-100 border-gray-300"
        }`;

        postElement.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-semibold uppercase text-gray-600">${post.tipo.replace(
                      "_",
                      " "
                    )}</span>
                    <span class="text-xs text-gray-500">${postDate}</span>
                </div>
                <h3 class="text-xl font-bold mb-2">${post.titulo}</h3>
                <p class="text-gray-700 mb-3">${post.contenido}</p>
                
                ${imagesHTML} <!-- ¡NUEVO! Insertar las imágenes -->

                <div class="flex justify-between items-center text-sm mt-4 pt-3 border-t">
                    <!-- ¡CAMBIO! Mostrar Nro. de Vivienda -->
                    <span class-"text-gray-600">Por: <b>Unidad ${
                      post.authorNroVivienda || "Desconocida"
                    }</b></span>
                    <div class="flex items-center">
                        <span class="text-yellow-500 mr-1">★</span>
                        <span class="font-bold">${
                          post.calificacionPost
                        } / 5</span>
                    </div>
                </div>
            `;
        postsFeed.appendChild(postElement);
      }

      // --- 7. UTILIDADES ---
      // ... (sin cambios)
      function showAppMessage(message, type = "success") {
        const messageContainer = document.getElementById("message-container");
        if (!messageContainer) return;

        const color = type === "success" ? "bg-green-500" : "bg-red-500";

        const messageElement = document.createElement("div");
        messageElement.className = `${color} text-white p-3 rounded-md shadow-lg fixed bottom-5 right-5 z-50`;
        messageElement.textContent = message;

        messageContainer.appendChild(messageElement);

        setTimeout(() => {
          messageElement.remove();
        }, 3000);
      }
    </script>
  </head>
  <body class="bg-gray-100 font-sans">
    <!-- Contenedor de mensajes (para notificaciones) -->
    <div
      id="message-container"
      class="fixed bottom-5 right-5 z-50 space-y-2"
    ></div>

    <!-- Spinner de carga inicial -->
    <div
      id="loading-spinner"
      class="flex items-center justify-center min-h-screen"
    >
      <div
        class="w-16 h-16 border-4 border-blue-500 border-dashed rounded-full animate-spin"
      ></div>
    </div>

    <!-- 1. CONTENEDOR DE AUTENTICACIÓN (Oculto si estás logueado) -->
    <div
      id="auth-container"
      class="hidden min-h-screen flex items-center justify-center"
    >
      <!-- ... (sin cambios en la sección de Auth) -->
      <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-4">
          Bienvenido a CongeniApp
        </h2>

        <!-- Pestañas -->
        <div class="border-b border-gray-200 mb-4">
          <nav class="-mb-px flex space-x-8" aria-label="Tabs">
            <a
              href="#"
              id="login-tab"
              role="tab"
              class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
              Iniciar Sesión
            </a>
            <a
              href="#"
              id="register-tab"
              role="tab"
              class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
              Registrarse
            </a>
          </nav>
        </div>

        <!-- Contenido Pestaña Login -->
        <div id="login-content">
          <form id="login-form">
            <div class="mb-4">
              <label
                for="login-email"
                class="block text-sm font-medium text-gray-700"
                >Email</label
              >
              <input
                type="email"
                id="login-email"
                name="email"
                required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div class="mb-6">
              <label
                for="login-password"
                class="block text-sm font-medium text-gray-700"
                >Contraseña</label
              >
              <input
                type="password"
                id="login-password"
                name="password"
                required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
              Iniciar Sesión
            </button>
          </form>
        </div>

        <!-- Contenido Pestaña Registro -->
        <div id="register-content" class="hidden">
          <form id="register-form">
            <div class="mb-4">
              <label
                for="reg-nombre"
                class="block text-sm font-medium text-gray-700"
                >Nombre Completo</label
              >
              <input
                type="text"
                id="reg-nombre"
                name="nombre"
                required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div class="mb-4">
              <label
                for="reg-email"
                class="block text-sm font-medium text-gray-700"
                >Email</label
              >
              <input
                type="email"
                id="reg-email"
                name="email"
                required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div class="mb-4">
              <label
                for="reg-password"
                class="block text-sm font-medium text-gray-700"
                >Contraseña (mín. 6 caracteres)</label
              >
              <input
                type="password"
                id="reg-password"
                name="password"
                required
                minlength="6"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <p class="text-xs text-gray-600 mb-4">
              Campos de validación (¡Importante!):
            </p>
            <div class="mb-4">
              <label
                for="reg-direccion"
                class="block text-sm font-medium text-gray-700"
                >Dirección</label
              >
              <input
                type="text"
                id="reg-direccion"
                name="direccion"
                required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div class="mb-4">
              <label
                for="reg-vivienda"
                class="block text-sm font-medium text-gray-700"
                >Nro. de Vivienda / Apartamento</label
              >
              <input
                type="text"
                id="reg-vivienda"
                name="nroVivienda"
                required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
            >
              Crear Cuenta
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- 2. CONTENEDOR DE LA APP (Oculto si NO estás logueado) -->
    <div id="app-container" class="hidden">
      <!-- Barra de navegación -->
      <nav class="bg-white shadow-md">
        <div class="max-w-6xl mx-auto px-4">
          <div class="flex justify-between items-center h-16">
            <div class="flex-shrink-0">
              <span class="text-2xl font-bold text-blue-600">CongeniApp</span>
            </div>
            <div class="flex items-center">
              <span id="user-info" class="text-sm text-gray-700 mr-4"></span>
              <button
                id="logout-button"
                class="bg-red-500 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-red-600"
              >
                Cerrar Sesión
              </button>
            </div>
          </div>
        </div>
      </nav>

      <!-- Contenido principal -->
      <main
        class="max-w-6xl mx-auto p-4 grid grid-cols-1 md:grid-cols-3 gap-8 mt-4"
      >
        <!-- Columna 1: Nuevo Post (¡ACTUALIZADO CON INPUTS DE FOTOS!) -->
        <aside class="md:col-span-1">
          <div class="bg-white p-6 rounded-lg shadow-lg sticky top-4">
            <h3 class="text-xl font-bold mb-4">Crear Nueva Publicación</h3>
            <form id="post-form" class="space-y-4">
              <div>
                <label
                  for="post-titulo"
                  class="block text-sm font-medium text-gray-700"
                  >Título</label
                >
                <input
                  type="text"
                  id="post-titulo"
                  name="titulo"
                  required
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div>
                <label
                  for="post-contenido"
                  class="block text-sm font-medium text-gray-700"
                  >Contenido</label
                >
                <textarea
                  id="post-contenido"
                  name="contenido"
                  rows="4"
                  required
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                ></textarea>
              </div>
              <div>
                <label
                  for="post-tipo"
                  class="block text-sm font-medium text-gray-700"
                  >Tipo de Publicación</label
                >
                <select
                  id="post-tipo"
                  name="tipo"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="ruido">Ruidos Molestos</option>
                  <option value="vecino_bueno">Buen Vecino</option>
                  <option value="vecino_malo">Mal Vecino</option>
                  <option value="prestaciones">Prestaciones (Amenities)</option>
                  <option value="espacio_verde">Espacios Verdes</option>
                </select>
              </div>
              <div>
                <label
                  for="post-calificacion"
                  class="block text-sm font-medium text-gray-700"
                  >Calificación (1-5)</label
                >
                <select
                  id="post-calificacion"
                  name="calificacion"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="5">5 ★★★★★ (Excelente)</option>
                  <option value="4">4 ★★★★☆ (Bueno)</option>
                  <option value="3">3 ★★★☆☆ (Regular)</option>
                  <option value="2">2 ★★☆☆☆ (Malo)</option>
                  <option value="1">1 ★☆☆☆☆ (Pésimo)</option>
                </select>
              </div>

              <!-- ¡NUEVO! Inputs para fotos -->
              <div>
                <label
                  for="post-foto1"
                  class="block text-sm font-medium text-gray-700"
                  >Foto 1 (Opcional)</label
                >
                <input
                  type="file"
                  id="post-foto1"
                  name="foto1"
                  accept="image/*"
                  class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
              </div>
              <div>
                <label
                  for="post-foto2"
                  class="block text-sm font-medium text-gray-700"
                  >Foto 2 (Opcional)</label
                >
                <input
                  type="file"
                  id="post-foto2"
                  name="foto2"
                  accept="image/*"
                  class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
              </div>
              <div>
                <label
                  for="post-foto3"
                  class="block text-sm font-medium text-gray-700"
                  >Foto 3 (Opcional)</label
                >
                <input
                  type="file"
                  id="post-foto3"
                  name="foto3"
                  accept="image/*"
                  class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
              </div>

              <button
                type="submit"
                id="post-submit-button"
                class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-opacity"
              >
                Publicar
              </button>
            </form>
          </div>
        </aside>

        <!-- Columna 2: Feed de Posts -->
        <section class="md:col-span-2">
          <h2 class="text-2xl font-bold mb-4 text-gray-800">
            Feed de la Comunidad
          </h2>
          <div id="posts-feed" class="space-y-6">
            <!-- Las publicaciones de Firestore se cargarán aquí -->
            <div class="text-center text-gray-500">
              Cargando publicaciones...
            </div>
          </div>
        </section>
      </main>
    </div>
  </body>
</html>
